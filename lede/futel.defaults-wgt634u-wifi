#!/bin/sh

uci batch <<EOF
add_list dhcp.@dnsmasq[0].notinterface=eth0.2
set dhcp.lan.force=1
commit dhcp

delete network.globals

set network.wan=interface
set network.wan.proto=dhcp
set network.wan.ifname=""
set network.wan.dns="8.8.8.8 8.8.4.4"

set network.wan6=interface
set network.wan6.ifname='@wan'
set network.wan6.proto='dhcpv6'
set network.wan6.reqprefix='60'

set network.vpn=interface
set network.vpn.ifname=tun0
set network.vpn.proto=none

commit network

delete openvpn.custom_config
delete openvpn.sample_server
delete openvpn.sample_client

set openvpn.fooudp=openvpn
set openvpn.fooudp.enabled=1
set openvpn.fooudp.client='1'
set openvpn.fooudp.dev='tun'
set openvpn.fooudp.proto='udp'
set openvpn.fooudp.remote='vpnbox-prod-foo.phu73l.net'
set openvpn.fooudp.resolve_retry='infinite'
set openvpn.fooudp.nobind='1'
set openvpn.fooudp.persist_key='1'
set openvpn.fooudp.persist_tun='0'
set openvpn.fooudp.keepalive='10 120'
set openvpn.fooudp.remote_cert_tls=server
set openvpn.fooudp.ca='/etc/openvpn/keys/ca.crt'
set openvpn.fooudp.cert='/etc/openvpn/keys/client.crt'
set openvpn.fooudp.key='/etc/openvpn/keys/client.key'
set openvpn.fooudp.compress='lzo'

set openvpn.footcp=openvpn
set openvpn.footcp.enabled=1
set openvpn.footcp.client='1'
set openvpn.footcp.dev='tun'
set openvpn.footcp.proto='tcp'
set openvpn.footcp.remote='vpnbox-prod-foo.phu73l.net'
set openvpn.footcp.resolve_retry='infinite'
set openvpn.footcp.nobind='1'
set openvpn.footcp.persist_key='1'
set openvpn.footcp.persist_tun='0'
set openvpn.footcp.keepalive='10 120'
set openvpn.footcp.remote_cert_tls=server
set openvpn.footcp.ca='/etc/openvpn/keys/ca.crt'
set openvpn.footcp.cert='/etc/openvpn/keys/client.crt'
set openvpn.footcp.key='/etc/openvpn/keys/client.key'
set openvpn.footcp.compress='lzo'

set openvpn.barudp=openvpn
set openvpn.barudp.enabled='1'
set openvpn.barudp.client='1'
set openvpn.barudp.dev='tun'
set openvpn.barudp.proto='udp'
set openvpn.barudp.remote='vpnbox-prod-bar.phu73l.net'
set openvpn.barudp.resolve_retry='infinite'
set openvpn.barudp.nobind='1'
set openvpn.barudp.persist_key='1'
set openvpn.barudp.persist_tun='0'
set openvpn.barudp.keepalive='10 120'
set openvpn.barudp.remote_cert_tls=server
set openvpn.barudp.ca='/etc/openvpn/keys/ca.crt'
set openvpn.barudp.cert='/etc/openvpn/keys/client.crt'
set openvpn.barudp.key='/etc/openvpn/keys/client.key'
set openvpn.barudp.compress='lzo'

set openvpn.bartcp=openvpn
set openvpn.bartcp.enabled='1'
set openvpn.bartcp.client='1'
set openvpn.bartcp.dev='tun'
set openvpn.bartcp.proto='tcp'
set openvpn.bartcp.remote='vpnbox-prod-bar.phu73l.net'
set openvpn.bartcp.resolve_retry='infinite'
set openvpn.bartcp.nobind='1'
set openvpn.bartcp.persist_key='1'
set openvpn.bartcp.persist_tun='0'
set openvpn.bartcp.keepalive='10 120'
set openvpn.bartcp.remote_cert_tls=server
set openvpn.bartcp.ca='/etc/openvpn/keys/ca.crt'
set openvpn.bartcp.cert='/etc/openvpn/keys/client.crt'
set openvpn.bartcp.key='/etc/openvpn/keys/client.key'
set openvpn.bartcp.compress='lzo'

commit openvpn

set system.@system[0].hostname=futel-gw
set system.@system[0].timezone='PST8PDT,M3.2.0,M11.1.0'
commit system

add firewall zone
set firewall.@zone[-1].input='ACCEPT'
set firewall.@zone[-1].forward='REJECT'
set firewall.@zone[-1].output='ACCEPT'
set firewall.@zone[-1].name='vpn'
set firewall.@zone[-1].masq='1'
set firewall.@zone[-1].mtu_fix='1'
set firewall.@zone[-1].network='vpn'

add firewall forwarding
set firewall.@forwarding[-1].dest='vpn'
set firewall.@forwarding[-1].src='lan'

commit firewall

set wireless.radio0.disabled='0'
set wireless.radio0.channel='auto'
set wireless.default_radio0.network='wan'
set wireless.default_radio0.mode='sta'
set wireless.default_radio0.ssid='REPLACEME'
set wireless.default_radio0.encryption='psk2'
set wireless.default_radio0.key='THISBETTERWORK'

commit wireless

EOF

/etc/init.d/odhcpd disable
/etc/init.d/odhcpd stop

